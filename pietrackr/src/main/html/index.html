<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>
    <script type="text/javascript"
      src="lib/mqttws31.js">
    </script>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC93yNqEP89_kQfdoRT8OIZUOAuOYGSDDs&sensor=true">
    </script>
    <script 
      src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">

		var username = getURLParameters("username");
		var password = getURLParameters("password");
		client = new Messaging.Client("mqtt.murf.se", 443, "WEB" + username);
		client.onConnectionLost = onConnectionLost;
		client.onMessageArrived = onMessageArrived;
		
		var size=19;        
		var img=new google.maps.MarkerImage('marker.png',           
			new google.maps.Size(size, size),
			new google.maps.Point(0,0),
			new google.maps.Point(size/2, size/2)
		);
		var infowindow =  new google.maps.InfoWindow({
			content: ''
		});
		var mapOptions = {
			center: new google.maps.LatLng(57.704156122,11.886816122),
			zoom: 17,
			mapTypeId: google.maps.MapTypeId.ROADMAP
			
	    };
	    var map;
	    var Location;
	    var marker;
	    var infowindow;
	    var deviceArray=new Array();
		google.maps.event.addDomListener(window, 'load', initialize);
		client.connect({onSuccess:onConnect, onFailure:onFailure, useSSL:true, userName:username, password:password});;
		

		function initialize() {
			map = new google.maps.Map(document.getElementById("map-canvas"),mapOptions);
			Location = {
				lat:57.704156122,
				lon:11.886816122, 
				title:'No Data',
				descr:'No Data'           
			};

		}
		function addMarker(lat, lng, descr, device) {
			marker = new google.maps.Marker({
				map: map,
				title: Location.title,
				position: new google.maps.LatLng(lat, lon),           
				icon: img
			});
			infowindow.setContent(Location.descr);
			bindInfoWindow(marker, map, infowindow, "<p>" + device + "</p>");  
			marker.setPosition( new google.maps.LatLng( Location.lat, Location.lon ) );
		}
		
		function onMessageArrived(message) {
			console.log("onMessageArrived:"+message.payloadString);
			//59.187668333,17.618505,0.026,48.3,1398277504
			//59.187676667,17.618515,1.09,48.4,1398277505

			var data2 = jQuery.parseJSON(message.payloadString);
			// Add Fuzzy later to update. aka minidiff 
			if((Location.lat - data2.lat) * -1 > 0.00001 || (Location.lon - data2.lon) * -1 > 0.00001) {
				Location.lat = data2.lat;
				Location.lon = data2.lon;
				Location.descr = "First " + data2.topic.split("/")[4] + "Speed: " + data2.speed + " Alt: " + data2.Alt;
				device = data2.topic.split("/")[4];
				addMarker(Location.lat, Location.lon, Location.descr, device );
		    	map.panTo( new google.maps.LatLng( Location.lat, Location.lon  ) );
	    	}	    	
		}
		
		function bindInfoWindow(marker, map, infowindow, html) { 
			google.maps.event.addListener(marker, 'mouseover', function() {
				infowindow.setContent(html); 
				infowindow.open(map, marker); 
			});
			google.maps.event.addListener(marker, 'mouseout', function() {
				infowindow.close();
			}); 
		}
		
		function onConnect() {
		  // Once a connection has been made, make a subscription
		  console.log("onConnect");
		  client.subscribe("display/" + username + "/web/#", {qos:1,onSuccess:onSubscribe,onFailure:onSubscribeFailure});
		};
		
		function onSubscribe(x) {
		  console.log('subscribe');
		}
		
		function onSubscribeFailure(x) {
		  console.log('subscribe failed');
		}
		
		function onFailure(responseObject) {
		  console.log(responseObject);
		  //connect();
		}
		function onConnectionLost(responseObject) {
		  if (responseObject.errorCode !== 0)
		    console.log("onConnectionLost:"+responseObject.errorMessage);
		  //connect();
		}
		function getURLParameters(paramName) {
			var sURL = window.document.URL.toString();  
		    if (sURL.indexOf("?") > 0)
		    {
		       var arrParams = sURL.split("?");         
		       var arrURLParams = arrParams[1].split("&");      
		       var arrParamNames = new Array(arrURLParams.length);
		       var arrParamValues = new Array(arrURLParams.length);     
		       var i = 0;
		       for (i=0;i<arrURLParams.length;i++)
		       {
		        var sParam =  arrURLParams[i].split("=");
		        arrParamNames[i] = sParam[0];
		        if (sParam[1] != "")
		            arrParamValues[i] = unescape(sParam[1]);
		        else
		            arrParamValues[i] = "No Value";
		       }
		
		       for (i=0;i<arrURLParams.length;i++)
		       {
		                if(arrParamNames[i] == paramName){
		            //alert("Param:"+arrParamValues[i]);
		                return arrParamValues[i];
		             }
		       }
		       return null;
		    }
		
		}
    </script>
  </head>
  <body>
    <div id="map-canvas"/>
  </body>
</html>